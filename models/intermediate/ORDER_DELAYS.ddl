WITH ORDERS AS (
    SELECT * FROM {{ref('stg_orders')}}
),

DELAY_PERIODS AS (
    SELECT * FROM {{ref('delay_periods')}}
),

ORDER_DELAYS AS (

    SELECT  
        ORDERS.ORDER_ID,
        ORDERS.DAYS_UNBALANCED,
        DELAY_PERIODS.DELAY_PERIOD
    
    FROM ORDERS
    LEFT JOIN DELAY_PERIODS
        ON ORDERS.DAYS_UNBALANCED > DELAY_PERIODS.DELAY_PERIOD
    WHERE ORDERS.IS_IN_DEFAULT = true
)

SELECT * FROM ORDER_DELAYS